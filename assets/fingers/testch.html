<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

	<title>Testing</title>

	<link rel="stylesheet" href="/assets/common/reset.css" type="text/css"/>

	<style>	
		* {
			border: none;
		}
		#raw, #rec {
			position: absolute;
			top: 0;
			left: 0;
			width: 50%;
			border: solid 1px white;
		}
		#rec {
			left: 50%;
		}
		#target {
			position: absolute;
			left: 50%;
			top: 50%;
			width: 0;
			height: 0;
			border-left: 50px solid transparent;
			border-right: 50px solid transparent;
			border-bottom: 100px solid red;
		}
		div.item {
			border-bottom: solid 1px darkolivegreen;
		}
	</style>

    <script src="/assets/common/common.js"></script>
    <script src="/assets/common/jquery.js"></script>
    <script src="/assets/joy/joy.js"></script>
	<script src="recognizer.js"></script>
	<script src="touch.parsers.js"></script>
	<script src="touch.event.js"></script>
	<script src="touch.debug.js"></script>
    <script>  
		function rectbound(rect, rel) {
			var el = null;
			if (!rel.$bound$) {
				el = document.createElement('div');
				rel.appendChild(el);
				rel.$bound$ = el;
			} else {
				el = rel.$bound$;
			}
			el.style.border = 'solid 1px red';
			el.style.position = 'absolute';
			el.style.left = rect.left + 'px';
			el.style.top = rect.top + 'px';
			el.style.width = rect.width + 'px';
			el.style.height = rect.height + 'px';
		}
		function rectdiff(target, rel) {
			var trect = target.getBoundingClientRect();
			var rrect = rel.getBoundingClientRect();
			var drect = {
				left: trect.left - rrect.left,
				top: trect.top - rrect.top,
				right: trect.right - rrect.right,
				bottom: trect.bottom - rrect.bottom,
				width: trect.width,
				height: trect.height,
			};
			//rectbound(drect, rel);
			return drect;
		}
		function transformable(target, rel) {
			if (!target) {
				return;
			}
			if (!rel) {
				rel = document.body;
			}
			var drect = rectdiff(target, rel);
			if (!target.style.left) {
				target.style.left = drect.left + 'px';
			}
			if (!target.style.top) {
				target.style.top = drect.top + 'px';
			}
			target.op = [parseFloat(target.style.left), parseFloat(target.style.top)];
			target.$transform$ = {
				scale: 1,
				rotate: 0,
				offset: [0, 0]
			};
			target.$origin$ = {
				scale: 1,
				rotate: 0,
				offset: [0, 0]
			};
			target.rotate = function(angle) {
				this.$transform$.rotate = angle;
			};
			target.offset = function(offset) {
				this.$transform$.offset = offset;
			};
			target.scale = function (scale) {
				this.$transform$.scale = scale;
			};
			target.update = function() {
				var state = this.$transform$;
				var o = this.$origin$;
				var scale = o.scale + state.scale;
				var s = ' ';
				s += ' ';
				s += 'scale(' + scale + ') ';
				s += 'rotate(' + (o.rotate + state.rotate) + 'deg) ';
				s += 'translate(' + (o.offset[0] + state.offset[0]) + 'px,' + (o.offset[1] + state.offset[1]) + 'px)';
				this.style.transform = s;
			};
			target.commit = function() {
				var state = this.$transform$;
				var o = this.$origin$;
				o.scale += state.scale;
				o.rotate += state.rotate;
				o.offset[0] += state.offset[0];
				o.offset[1] += state.offset[1];
				state.scale = 1;
				state.rotate = 0;
				state.offset = [0, 0];
			}
			return drect;
		}
		$(function () {
			document.oncontextmenu = function() {
				return false;
			};
			var rel = document.body;
			var target = $('#target')[0];
			transformable(target, rel);
			var origin = null;

			touch({
				target: document,
				rel: rel
			}).on({
				zoomstart: function (it) {
					origin = it;
				}, zooming: function (it) {
					if (origin) {
						var op = target.op;
						var d = { rpos: [it.rpos[0] - origin.rpos[0], it.rpos[1] - origin.rpos[1]], len: it.len / origin.len - 1, angle: it.angle - origin.angle };
						var x = op[0] + d.rpos[0];
						var y = op[1] + d.rpos[1];
						target.style.left = x + 'px';
						target.style.top = y + 'px';
						target.rotate(d.angle);
						target.scale(d.len);
						target.update();
					}
				}, zoomend: function (it) {
					var x = parseFloat(target.style.left);
					var y = parseFloat(target.style.top);
					var op = target.op;
					op[0] = x;
					op[1] = y;
					target.commit();
					origin = null;
				}
			});
		});
    </script>
</head>
<body>

	<div id="target"></div>
	<div id="raw"></div>
	<div id="rec"></div>

<div class="z-topmost crop noborder noselect .transparent fill-fixed" sstyle="background-color: silver;">
</div>

</body>
</html>